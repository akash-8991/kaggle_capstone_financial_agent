version: '3.8'

services:
  # Main Financial Advisor Agent
  financial-advisor:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: development
    container_name: financial-advisor
    ports:
      - "8000:8000"  # ADK Web UI
      - "8080:8080"  # API Server
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-FALSE}
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-}
      - GOOGLE_CLOUD_LOCATION=${GOOGLE_CLOUD_LOCATION:-us-central1}
      - LOG_LEVEL=INFO
      - DEBUG=true
    volumes:
      - ..:/app
      - agent-logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - agent-network

  # A2A Protocol Server
  a2a-server:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: production
    container_name: a2a-server
    ports:
      - "8001:8001"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - A2A_SERVER_PORT=8001
      - LOG_LEVEL=INFO
    command: ["python", "-m", "a2a.a2a_server", "--port", "8001"]
    depends_on:
      - financial-advisor
    networks:
      - agent-network

  # Observability Stack (Optional)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - agent-network
    profiles:
      - observability

  # Prometheus for Metrics (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - agent-network
    profiles:
      - observability

networks:
  agent-network:
    driver: bridge

volumes:
  agent-logs:
